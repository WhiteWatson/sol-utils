# 钱包连接功能说明

## 概述

本项目已集成了完整的 Web3 钱包连接功能，支持多种主流钱包，包括 OKX、Phantom、MetaMask 等。**新增钱包连接状态持久化功能，页面刷新后自动恢复连接状态。**

## 支持的钱包

### Solana 钱包

- **Phantom** 👻 - 最受欢迎的 Solana 钱包
- **Solflare** 🔥 - 功能强大的 Solana 钱包
- **Backpack** 🎒 - 新一代 Solana 钱包
- **Slope** 📱 - 移动端友好的 Solana 钱包
- **Exodus** 🚀 - 多链钱包，支持 Solana

### 其他钱包

- **OKX Wallet** 🟢 - OKX 交易所钱包
- **MetaMask** 🦊 - 以太坊主流钱包
- **Coinbase Wallet** 🪙 - Coinbase 交易所钱包

## 功能特性

### 1. 自动检测

- 自动检测浏览器中已安装的钱包插件
- 实时显示钱包安装状态
- 智能识别钱包类型

### 2. 一键连接

- 点击即可连接到已安装的钱包
- 支持多钱包同时连接
- 连接状态实时同步

### 3. 状态管理

- **连接状态持久化** - 页面刷新后自动恢复连接
- 钱包地址自动获取
- 断开连接功能
- 连接过期自动清理（默认 24 小时）

### 4. 用户界面

- 现代化的 UI 设计
- 响应式布局
- 直观的状态指示器
- 自动连接状态显示

## 使用方法

### 1. 连接钱包

1. 点击右上角的"连接钱包"按钮
2. 在弹出的模态框中选择要连接的钱包
3. 如果钱包未安装，会显示"未安装"状态
4. 点击已安装的钱包进行连接

### 2. 管理钱包

1. 访问"钱包管理"页面
2. 查看所有已连接的钱包
3. 可以断开不需要的钱包连接
4. 刷新钱包列表

### 3. 自动恢复连接

- **页面刷新后自动恢复**: 系统会自动检测并恢复之前的钱包连接
- **连接状态显示**: 页面加载时会显示"自动连接中..."状态
- **智能验证**: 自动验证钱包地址是否匹配，确保安全性

## 技术实现

### 核心文件

- `src/services/walletService.ts` - 钱包服务核心逻辑
- `src/services/storageService.ts` - 存储服务，处理连接状态持久化
- `src/contexts/WalletContext.tsx` - 钱包状态管理
- `src/components/layout/HeaderBar/WalletConnector.tsx` - 钱包连接组件
- `src/pages/Wallet/WalletManagement/` - 钱包管理页面

### 主要功能

- **钱包检测**: 自动检测浏览器中的钱包插件
- **连接管理**: 处理钱包连接和断开
- **状态同步**: 实时同步钱包连接状态
- **事件监听**: 监听钱包状态变化
- **状态持久化**: 使用 localStorage 保存连接信息
- **自动恢复**: 页面加载时自动恢复连接状态

### 持久化机制

1. **连接信息存储**: 连接成功后将钱包信息保存到 localStorage
2. **自动恢复**: 页面加载时读取保存的连接信息
3. **智能验证**: 验证钱包是否仍然连接且地址匹配
4. **过期清理**: 自动清理超过 24 小时的连接信息
5. **错误处理**: 连接失败时自动清理无效的连接信息

## 开发指南

### 添加新钱包支持

1. 在 `WalletType` 枚举中添加新钱包类型
2. 在 `detectWallet` 函数中添加检测逻辑
3. 在 `getWalletInstance` 函数中添加获取实例逻辑
4. 在 `getWalletName` 和 `getWalletIcon` 函数中添加显示信息

### 示例代码

```typescript
// 添加新钱包类型
export enum WalletType {
  // ... 现有钱包
  NEW_WALLET = 'new_wallet',
}

// 检测钱包
case WalletType.NEW_WALLET:
  return 'newWallet' in window;

// 获取钱包实例
case WalletType.NEW_WALLET:
  return window.newWallet;
```

## 注意事项

### 1. 浏览器兼容性

- 需要现代浏览器支持
- 钱包插件需要正确安装
- 某些钱包可能需要特定的浏览器版本
- localStorage 需要可用

### 2. 安全性

- 钱包连接需要用户授权
- 私钥不会暴露给应用
- 连接信息仅保存钱包类型和地址
- 建议在测试环境中先验证功能

### 3. 错误处理

- 连接失败时会显示错误信息
- 网络问题会自动重试
- 用户取消连接会正确处理
- 无效连接会自动清理

## 故障排除

### 常见问题

1. **钱包未检测到**

   - 确保钱包插件已正确安装
   - 刷新页面重新检测
   - 检查浏览器控制台是否有错误

2. **连接失败**

   - 检查钱包是否已解锁
   - 确认网络连接正常
   - 查看错误信息进行排查

3. **状态不同步**

   - 刷新页面重新加载状态
   - 检查钱包插件是否正常运行
   - 清除浏览器缓存重试

4. **自动恢复失败**
   - 检查 localStorage 是否可用
   - 确认钱包插件仍然安装
   - 查看浏览器控制台的错误信息

## 更新日志

### v1.1.0

- ✅ 新增钱包连接状态持久化功能
- ✅ 页面刷新后自动恢复连接状态
- ✅ 智能连接验证和过期清理
- ✅ 改进的用户界面和状态显示

### v1.0.0

- 初始版本发布
- 支持 8 种主流钱包
- 完整的连接管理功能
- 现代化的用户界面

## 贡献

欢迎提交 Issue 和 Pull Request 来改进钱包连接功能！

## 许可证

本项目采用 MIT 许可证。
